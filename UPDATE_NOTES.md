# 更新说明 - v2 Hook 重要改进

## 🚨 重要更新 (2025-09-08)

本次更新修复了多个关键问题，特别是缓冲区无限增长的Bug。

### 🐛 修复的关键问题

1. **缓冲区清理Bug修复**
   - 问题：部分成功的批次不会清理已成功的记录，导致重复发送
   - 修复：实现精确的部分成功处理，只保留真正失败的记录

2. **大文件处理优化**
   - 问题：大缓冲文件（>10000条记录）处理缓慢
   - 修复：实现一次性激进处理模式，快速清理积压数据

3. **URL标准化**
   - 问题：serverUrl末尾斜杠导致API调用失败
   - 修复：自动标准化URL，移除末尾斜杠

### ✨ 新增功能

- **智能大文件检测**：自动检测并处理异常大的缓冲文件
- **精确的成功追踪**：记录每个具体记录的发送状态
- **更好的错误恢复**：失败记录自动保留重试

### 📦 如何更新

#### 对于现有用户

如果你已经安装了 claude-stats，请执行以下步骤更新到最新版：

```bash
# 1. 更新代码
git pull

# 2. 重新链接CLI（在client目录下）
cd client
npm link

# 3. 强制更新Hook到最新版
claude-stats update-hook-to-v2 --force
```

#### 检查更新是否成功

```bash
# 查看Hook版本
claude-stats hook-version

# 查看缓冲区状态
claude-stats debug
```

### ⚠️ 注意事项

如果你有大量积压数据（>5000条），更新后的Hook会：
1. 自动检测大缓冲文件
2. 一次性处理所有积压数据
3. 处理可能需要几分钟，请耐心等待

### 🔍 问题排查

如果遇到问题：

1. **启用调试日志**
   ```bash
   export CLAUDE_STATS_DEBUG=true
   ```

2. **查看日志文件**
   ```bash
   tail -f ~/.claude/stats-debug.log
   ```

3. **手动清理缓冲（慎用）**
   ```bash
   claude-stats cleanup -f
   ```

### 📝 更新内容详情

- 修复了 `sendBatchWithRetry` 函数的部分成功处理逻辑
- 优化了大文件处理策略，从渐进式改为一次性处理
- 降低了大文件检测阈值（5MB→2MB，10000→5000条）
- 添加了 `--force` 选项支持强制更新Hook

---

如有问题，请在GitHub Issues中反馈。