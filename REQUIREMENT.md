# 功能需求文档 (REQUIREMENT.md)

## 项目概述

**项目名称**: Claude Code Leaderboard CLI  
**版本**: 0.2.9  
**目标**: 自动跟踪 Claude Code 使用情况并参与全球排行榜的命令行工具

## 核心功能需求

### 1. 用户认证管理

#### 1.1 Twitter OAuth 认证
- **需求描述**: 使用 OAuth 1.0a 协议进行 Twitter 身份验证
- **功能要点**:
  - 启动本地 Express 服务器监听端口 7632
  - 自动打开浏览器进行 Twitter 授权
  - 处理授权回调并获取访问 token
  - 加密存储 OAuth token 到本地配置文件
  - 支持重新认证功能

#### 1.2 认证状态管理
- **需求描述**: 管理和验证用户认证状态
- **功能要点**:
  - 检查当前认证状态
  - 显示认证用户信息（Twitter handle, User ID）
  - token 加密存储（AES-256-GCM）
  - 认证超时处理（5分钟）

### 2. 使用数据跟踪

#### 2.1 自动 Hook 安装
- **需求描述**: 在 Claude Code 中安装自动跟踪 Hook
- **功能要点**:
  - 创建 `~/.claude/count_tokens.js` Hook 脚本
  - 更新 `~/.claude/settings.json` 注册 Stop Hook
  - 创建 `~/.claude/package.json` 支持 ES 模块
  - Hook 版本自动更新机制

#### 2.2 使用数据收集
- **需求描述**: 收集 Claude Code 会话的 token 使用数据
- **功能要点**:
  - 扫描 Claude 项目目录中的 `.jsonl` 文件
  - 提取 token 使用统计信息：
    - 输入 token (input_tokens)
    - 输出 token (output_tokens)
    - 缓存创建 token (cache_creation_input_tokens)
    - 缓存读取 token (cache_read_input_tokens)
  - 生成交互哈希值用于去重
  - 记录模型类型和时间戳

#### 2.3 数据提交
- **需求描述**: 自动提交使用数据到后端服务
- **功能要点**:
  - Claude Code 会话结束时自动触发
  - 通过 SHA256 哈希防止重复提交
  - 包含 CLI 版本头用于兼容性检查
  - 10秒网络超时设置
  - 静默失败，不阻塞 Claude Code

### 3. 历史数据管理

#### 3.1 历史数据扫描
- **需求描述**: 扫描并收集所有历史使用数据
- **功能要点**:
  - 递归扫描 Claude 项目目录
  - 支持多个 Claude 配置路径
  - 基于 messageId 和 requestId 的去重机制
  - 显示扫描进度（可选）

#### 3.2 批量上传
- **需求描述**: 批量上传历史数据到服务器
- **功能要点**:
  - 新用户首次认证时自动执行
  - 按日期分组数据
  - 批量大小限制（5000条）
  - 并发控制（最多3个并发请求）
  - 重试机制（失败重试3次）
  - 进度显示和错误处理

### 4. 配置管理

#### 4.1 配置文件结构
- **需求描述**: 管理应用配置和用户设置
- **主要配置文件**:
  - `~/.claude/leaderboard.json`: 用户认证和 API 配置
  - `~/.claude/settings.json`: Claude Code Hook 设置
  - `~/.claude/.encryption_key`: token 加密密钥
  - `~/.claude/leaderboard_submitted.json`: 已提交数据跟踪

#### 4.2 配置迁移
- **需求描述**: 处理版本升级时的配置迁移
- **功能要点**:
  - 检测旧版本配置
  - 自动迁移到新格式
  - 保留用户数据完整性

### 5. 重置和卸载

#### 5.1 完整重置功能
- **需求描述**: 提供完整的重置和卸载选项
- **功能要点**:
  - 删除所有本地配置文件
  - 从 Claude Code 设置中移除 Hook
  - 可选：从服务器数据库删除账户
  - 双重确认机制（输入用户名确认）
  - 详细模式显示删除结果

#### 5.2 自动重置检测
- **需求描述**: 版本更新时自动处理必要的重置
- **功能要点**:
  - 检测需要重置的情况
  - 自动执行账户重置
  - 提示用户重新认证

### 6. 版本管理

#### 6.1 版本兼容性检查
- **需求描述**: 确保 CLI 和后端版本兼容
- **功能要点**:
  - Hook 脚本版本与 CLI 版本同步
  - API 请求包含版本头
  - HTTP 426 响应触发升级要求
  - 版本不匹配时阻止执行（退出码 2）

### 7. 用户界面

#### 7.1 命令行界面
- **需求描述**: 提供友好的命令行交互界面
- **主要命令**:
  - `claudecount`: 默认命令，检查认证状态或开始设置
  - `claudecount auth`: 执行认证流程
  - `claudecount reset`: 重置配置和清除数据
  - `claudecount help`: 显示帮助信息

#### 7.2 视觉反馈
- **需求描述**: 提供清晰的视觉反馈
- **功能要点**:
  - 彩色输出（使用 chalk）
  - 进度指示器（使用 ora）
  - 清晰的错误消息
  - 操作确认提示

### 8. 错误处理

#### 8.1 网络错误处理
- **需求描述**: 优雅处理网络相关错误
- **功能要点**:
  - 网络超时处理
  - 重试机制
  - 友好的错误提示
  - 故障排除建议

#### 8.2 认证错误处理
- **需求描述**: 处理认证相关错误
- **功能要点**:
  - 401 错误提示重新认证
  - 426 错误提示版本升级
  - OAuth 流程超时处理
  - 用户拒绝授权处理

### 9. 数据隐私

#### 9.1 数据收集范围
- **需求描述**: 明确定义收集的数据范围
- **收集内容**:
  - token 使用统计
  - 时间戳
  - 模型名称
  - Twitter 用户信息
- **不收集内容**:
  - 实际的提示词内容
  - Claude 的响应内容
  - 用户的代码或文件

#### 9.2 数据安全
- **需求描述**: 确保用户数据安全
- **安全措施**:
  - OAuth token 本地加密存储
  - HTTPS 传输
  - 最小权限原则
  - 可完全删除所有数据

## 非功能性需求

### 性能需求
- Hook 执行不应阻塞 Claude Code 操作
- API 请求超时限制 10 秒
- 批量上传并发限制 3 个请求

### 兼容性需求
- Node.js >= 16.0.0
- 支持 macOS、Linux、Windows
- Claude Code CLI 已安装配置

### 可用性需求
- 一键安装设置
- 清晰的错误消息和解决方案
- 无需手动干预的自动跟踪

### 可维护性需求
- 模块化代码结构
- 版本自动更新机制
- 配置自动迁移

## 部署需求

### NPM 发布
- 包名：claude-code-leaderboard
- 入口点：bin/cli.js
- 全局安装命令：`npx claude-code-leaderboard`

### 文件分发
- 包含文件：bin/, src/, hooks/, package.json, README.md
- 排除文件：node_modules/, .git/, 测试文件

## API 接口需求

### 后端 API 端点
- 基础 URL: https://api.claudecount.com
- 主要端点：
  - `/api/auth/oauth1a/*`: OAuth 认证流程
  - `/api/usage/hook`: 提交使用数据
  - `/api/usage/bulk`: 批量上传历史数据
  - `/api/user/delete`: 删除用户账户
  - `/api/user/stats`: 获取用户统计

### 数据格式
- 请求格式：JSON
- 认证方式：OAuth 1.0a token 在请求头传递
- 版本控制：X-CLI-Version 请求头